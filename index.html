<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buscar Medicamento</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 8px; align-items: center; }
    input { flex: 1; padding: 12px; font-size: 16px; }
    button { padding: 12px 16px; font-size: 16px; border: 0; border-radius: 8px; }
    #cancel { background: #eee; }
    ul { list-style: none; padding: 0; margin: 8px 0 0 0; border: 1px solid #ddd; border-radius: 8px; }
    li { padding: 10px 12px; cursor: pointer; }
    li + li { border-top: 1px solid #eee; }
    li:active { background: #f1f1f1; }
    .muted { color: #666; font-size: 14px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="row">
    <input id="q" type="text" placeholder="Digite o nome do medicamento..." autocomplete="off" />
    <button id="cancel">Voltar</button>
  </div>


  
  <div id="dbg" class="muted" style="margin-top:8px"></div>
  <button id="ping" style="margin-top:8px; display:none;">ENVIAR PING</button>

  <ul id="list"></ul>
  <div class="muted">Mostrando no m√°ximo 5 itens.</div>

  <script>
    const tg = window.Telegram?.WebApp;
    const Q = document.getElementById('q');
    const LIST = document.getElementById('list');
    const BTN_CANCEL = document.getElementById('cancel');
    const DBG = document.getElementById('dbg');
    const BTN_PING = document.getElementById('ping');

    // Caminho do JSON hospedado no mesmo reposit√≥rio do Pages
    const JSON_URL = './dropmed.json?v=' + Date.now();

    let DATA = [];
    let LAST_FILTER = '';
    let SELECTED = null;

    // ==== Status de SDK / Debug ====
    function showDbg(msg) {
      DBG.textContent = msg;
    }

    if (!tg) {
      showDbg("SDK N√ÉO DETECTADO ‚Äî p√°gina abriu fora do Telegram WebApp");
    } else {
      showDbg("SDK OK ‚Äî plataforma: " + (tg.platform || "desconhecida"));
      BTN_PING.style.display = 'inline-block';
      BTN_PING.onclick = () => {
        try {
          tg.sendData(JSON.stringify({ ping: true, ts: Date.now() }));
          tg.close();
        } catch (e) {
          alert("sendData falhou: " + e);
        }
      };
    }

    tg?.ready();
    tg?.expand();

    // ===== Fun√ß√µes auxiliares =====
    function norm(s) {
      return (s || '').normalize('NFKD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
    }

    // ===== Envio pelo bot√£o azul =====
    function enableMainButton(text = "Enviar sele√ß√£o") {
      if (!tg) return;
      tg.MainButton.setText(text);
      tg.MainButton.show();
      tg.MainButton.onClick(() => {
        if (!SELECTED) {
          tg.showAlert?.("Nenhum item selecionado.");
          return;
        }
        try {
          tg.sendData(JSON.stringify(SELECTED));
          // Sem fechar imediatamente ‚Äî mais seguro no Android
          tg.showAlert?.("Enviado ao bot!");
        } catch (e) {
          tg.showAlert?.("Falha ao enviar: " + e);
        }
      });
    }

    // ===== Renderiza√ß√£o da lista =====
    function render(filter) {
      LAST_FILTER = filter = norm(filter);
      LIST.innerHTML = '';
      if (!DATA.length) return;

      const max = 5;
      let count = 0;

      for (const item of DATA) {
        const name = item.produto_desc || '';
        if (filter && !norm(name).includes(filter)) continue;

        const li = document.createElement('li');
        li.textContent = name;
        li.onclick = () => {
          SELECTED = {
            produto_recnum: Number(item.produto_recnum),
            produto_desc: name
          };
          tg.HapticFeedback?.impactOccurred?.("light");
          try {
            tg.sendData(JSON.stringify(SELECTED));
            // ‚ö†Ô∏è N√£o fechar imediatamente: alguns Android perdem o pacote
            enableMainButton("Enviado! Voc√™ j√° pode fechar.");
            // Se mesmo assim quiser fechar sozinho, use um tempo maior:
            // setTimeout(() => tg.close(), 800);
          } catch (e) {
            enableMainButton("Enviar sele√ß√£o");
            tg.showAlert?.("Toque em 'Enviar sele√ß√£o' para concluir.");
          }
        };


        LIST.appendChild(li);

        if (++count >= max) break;
      }
    }

    // ===== Cancelar/Voltar =====
    BTN_CANCEL.onclick = () => {
      try {
        tg.sendData(JSON.stringify({ cancel: true }));
      } catch (e) {}
      tg.close();
    };

    // ===== Filtro em tempo real =====
    Q.addEventListener('input', (e) => render(e.target.value));

    // ===== Carrega o JSON =====
    fetch(JSON_URL, { cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(json => {
        DATA = Array.isArray(json) ? json : [];
        render(Q.value);
      })
      .catch(err => {
        console.error('Erro carregando dropmed.json:', err);
        LIST.innerHTML = '<li style="color:#b00">Falha ao carregar a lista. Tente novamente mais tarde.</li>';
      });
  </script>
    <!-- üîπ Bot√£o opcional para conceder permiss√£o de escrita ao bot -->
  <button id="grant" style="margin-top:8px;">Conectar ao bot</button>

  <script>
    const grant = document.getElementById('grant');
    grant.onclick = () => {
      const tg = window.Telegram?.WebApp;
      tg?.requestWriteAccess((ok) => {
        if (ok)
          tg.showAlert?.("Permiss√£o concedida. O bot pode enviar mensagens iniciadas pelo app.");
        else
          tg.showAlert?.("Permiss√£o negada.");
      });
    };
  </script>
</body>
</html>

</body>
</html>
